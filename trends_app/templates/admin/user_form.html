<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ 'Create' if not user else 'Edit' }} User</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container mt-4">
    <h1 class="mb-4">{{ 'Create New User' if not user else 'Edit User: ' + user.username }}</h1>

    <div class="card">
        <div class="card-body">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
              {% endif %}
            {% endwith %}
            
            <form method="POST">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" name="username" value="{{ user.username if user else '' }}" required>
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" name="password" {% if not user %}required{% endif %}>
                    {% if user %}<small class="form-text text-muted">Leave blank to keep the current password.</small>{% endif %}
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="is_admin" name="is_admin" value="true" {% if user and user.is_admin %}checked{% endif %}>
                    <label class="form-check-label" for="is_admin">Is Administrator?</label>
                </div>

                <div class="mb-3">
                    <label for="companies" class="form-label">Company Access</label>
                    <select class="form-select" id="companies" name="companies" multiple size="5">
                        {% for company in all_companies %}
                            <option value="{{ company.id }}" {% if user and company.id in user_company_ids %}selected{% endif %}>
                                {{ company.company_name }}
                            </option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Hold Ctrl or Cmd to select multiple companies.</small>
                </div>

                <div class="mb-3">
                    <label for="privileges" class="form-label">Privileges</label>
                    <select class="form-select" id="privileges" name="privileges" multiple size="5">
                         {% for priv in all_privileges %}
                            <option value="{{ priv.id }}" {% if user and priv.name in user_privileges %}selected{% endif %}>
                                {{ priv.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <a href="{{ url_for('admin.list_users') }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Save User</button>
            </form>
        </div>
    </div>
</div>
</body>
</html>
