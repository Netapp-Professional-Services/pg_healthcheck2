{% extends "base.html" %}

{% block title %}Report History - Health Check Trends{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
    <h2 class="text-lg font-semibold text-slate-900">Report History</h2>
    <div class="flex gap-2">
        {% if current_user.has_privilege('UploadReports') %}
        <a href="{{ url_for('profile.upload_report_form') }}" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-colors">
            <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"></path>
            </svg>
            Upload Report
        </a>
        {% endif %}
        <a href="{{ url_for('main.dashboard') }}" class="px-3 py-1.5 bg-white border border-slate-300 text-slate-700 text-sm hover:bg-slate-50 transition-colors">
            Back to Dashboard
        </a>
    </div>
</div>

<div class="bg-white border border-slate-200">
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-slate-50 border-b border-slate-200">
                <tr>
                    <th class="px-4 py-2.5 text-left text-xs font-semibold text-slate-700">Report Name</th>
                    <th class="px-4 py-2.5 text-left text-xs font-semibold text-slate-700">Description</th>
                    <th class="px-4 py-2.5 text-left text-xs font-semibold text-slate-700">Date</th>
                    <th class="px-4 py-2.5 text-left text-xs font-semibold text-slate-700">Source</th>
                    <th class="px-4 py-2.5 text-left text-xs font-semibold text-slate-700">Target</th>
                    <th class="px-4 py-2.5 text-left text-xs font-semibold text-slate-700">Actions</th>
                </tr>
            </thead>
            <tbody id="report-history-table-body" class="divide-y divide-slate-200">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>
    <div id="loading-spinner" class="p-8 text-center hidden">
        <div class="inline-block w-8 h-8 border-4 border-slate-300 border-t-blue-600 rounded-full animate-spin"></div>
    </div>
</div>

<!-- Edit Report Modal -->
<div id="editReportModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white border border-slate-300 shadow-xl w-full max-w-md mx-4">
        <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between bg-slate-50">
            <h3 class="text-sm font-semibold text-slate-900">Edit Report Details</h3>
            <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        <div class="p-4 space-y-3">
            <input type="hidden" id="edit-report-id">
            <input type="hidden" id="edit-report-type">
            <div>
                <label for="edit-report-name" class="block text-xs font-medium text-slate-700 mb-1">Report Name</label>
                <input type="text" id="edit-report-name" class="w-full px-2.5 py-1.5 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="edit-report-description" class="block text-xs font-medium text-slate-700 mb-1">Description</label>
                <textarea id="edit-report-description" rows="3" class="w-full px-2.5 py-1.5 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            <div>
                <label for="edit-annotations" class="block text-xs font-medium text-slate-700 mb-1">Annotations</label>
                <textarea id="edit-annotations" rows="5" class="w-full px-2.5 py-1.5 text-sm border border-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
        </div>
        <div class="px-4 py-3 bg-slate-50 border-t border-slate-200 flex justify-end gap-2">
            <button onclick="closeEditModal()" class="px-3 py-1.5 text-sm text-slate-700 bg-white border border-slate-300 hover:bg-slate-50">
                Cancel
            </button>
            <button id="save-report-changes-btn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium">
                Save Changes
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.getElementById('report-history-table-body');
    const loadingSpinner = document.getElementById('loading-spinner');

    function fetchReportHistory() {
        loadingSpinner.classList.remove('hidden');
        tableBody.innerHTML = '';

        fetch("{{ url_for('main.get_all_reports') }}")
            .then(response => response.json())
            .then(data => {
                loadingSpinner.classList.add('hidden');
                if (data.error) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-red-600">${data.error}</td></tr>`;
                    return;
                }
                if (data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-slate-500">No reports found.</td></tr>`;
                    return;
                }

                data.forEach(report => {
                    const isGenerated = report.type === 'generated';
                    const targetInfo = isGenerated ? `<span class="text-xs">${report.target_host}<br>(${report.db_name})</span>` : 'N/A';
                    const sourceInfo = isGenerated ? `AI: ${report.profile_name || '<em>(deleted)</em>'}` : 'Manual Upload';

                    const row = `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-2.5 text-slate-900">${report.name || ''}</td>
                            <td class="px-4 py-2.5 text-slate-700">${report.description || ''}</td>
                            <td class="px-4 py-2.5 text-slate-700">${new Date(report.timestamp).toLocaleString()}</td>
                            <td class="px-4 py-2.5 text-slate-700 text-xs">${sourceInfo}</td>
                            <td class="px-4 py-2.5 text-slate-700">${targetInfo}</td>
                            <td class="px-4 py-2.5">
                                <div class="flex gap-1">
                                    <a href="/profile/view-report/${report.type}/${report.id}" class="px-2 py-1 text-xs border border-blue-300 text-blue-700 hover:bg-blue-50 transition-colors">View</a>
                                    <button class="edit-btn px-2 py-1 text-xs border border-amber-300 text-amber-700 hover:bg-amber-50 transition-colors" 
                                        data-report-id="${report.id}" 
                                        data-report-type="${report.type}"
                                        data-name="${report.name || ''}" 
                                        data-description="${report.description || ''}" 
                                        data-annotations="${report.annotations || ''}">Edit</button>
                                    ${isGenerated ? `<a href="/api/download-report/${report.id}" class="px-2 py-1 text-xs border border-green-300 text-green-700 hover:bg-green-50 transition-colors">Download</a>` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            })
            .catch(err => {
                loadingSpinner.classList.add('hidden');
                tableBody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-red-600">Failed to load report history.</td></tr>`;
                console.error(err);
            });
    }

    tableBody.addEventListener('click', function(event) {
        if (event.target.classList.contains('edit-btn')) {
            const button = event.target;
            document.getElementById('edit-report-id').value = button.dataset.reportId;
            document.getElementById('edit-report-type').value = button.dataset.reportType;
            document.getElementById('edit-report-name').value = button.dataset.name;
            document.getElementById('edit-report-description').value = button.dataset.description;
            
            const annotationsTextarea = document.getElementById('edit-annotations');
            if (button.dataset.reportType === 'generated') {
                annotationsTextarea.value = button.dataset.annotations;
                annotationsTextarea.closest('div').style.display = 'block';
            } else {
                annotationsTextarea.value = '';
                annotationsTextarea.closest('div').style.display = 'none';
            }
            
            document.getElementById('editReportModal').classList.remove('hidden');
            document.getElementById('editReportModal').classList.add('flex');
        }
    });

    document.getElementById('save-report-changes-btn').addEventListener('click', function() {
        const reportId = document.getElementById('edit-report-id').value;
        const reportType = document.getElementById('edit-report-type').value;
        const payload = {
            report_name: document.getElementById('edit-report-name').value,
            report_description: document.getElementById('edit-report-description').value,
            annotations: document.getElementById('edit-annotations').value
        };

        const saveUrl = reportType === 'generated' ? `/api/generated-reports/${reportId}` : `/api/uploaded-reports/${reportId}`;

        fetch(saveUrl, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                closeEditModal();
                fetchReportHistory();
            } else {
                alert('Failed to save changes: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => alert('An error occurred: ' + err));
    });

    fetchReportHistory();
});

function closeEditModal() {
    document.getElementById('editReportModal').classList.add('hidden');
    document.getElementById('editReportModal').classList.remove('flex');
}
</script>
{% endblock %}
