= On-Demand AI Report Generation
:doctype: article
:toc: left
:toclevels: 3
:sectnums:

An integrated feature of the pg_healthcheck Trend Analysis Web Application.

== Overview

This document outlines the features and usage of the on-demand AI report generation system within the `trends_app`. This system allows authorized users to generate, store, and manage detailed, AI-powered analysis reports directly from the web interface.

The entire feature is designed to be fully decoupled from the main `pg_healthcheck` application, relying solely on the `health_trends` database for its configuration and data. This ensures the web application can be deployed and maintained independently.

== 1. Administrator Setup

Before users can generate reports, a system administrator must configure the available AI providers. This is a one-time setup that defines which AI models the application can connect to.

=== 1.1. Configuring AI Providers

Administrators can manage AI providers from the admin section of the web application.

. Navigate to `/admin/ai-providers`.
. Use the "Create New AI Provider" form to add a new configuration.
. *System API Key (Optional):* If the system will use a global API key for this provider, it can be entered here. It will be securely encrypted in the database.
. *Allow User Keys:* Check this box if you want to permit individual users to provide their own API keys for this provider, which is common in corporate environments.

image::docs/images/admin_ai_providers.png[Admin AI Providers Page]

== 2. User Configuration: AI Profiles

Each user manages their own set of "AI Profiles". A profile is a saved configuration that tells the system which AI provider to use and what parameters to apply for a report generation task.

=== 2.1. Managing Your AI Profiles

. Navigate to the "AI Settings" page from the link in the dashboard header.
. Use the "Create New AI Profile" form to define a new configuration.
. *Select a Provider:* Choose from the list of active providers configured by the administrator.
. *Parameters:* Set personal preferences for `Temperature` and `Max Tokens`.
. *Personal Credentials (Optional):* If the selected provider allows it, you can enter your own personal API key and/or a proxy username. These will be securely encrypted and will override any system-wide key for your requests.
. The table on the right allows you to view, edit, and delete your saved profiles.

image::docs/images/user_ai_settings.png[User AI Settings Page]

== 3. Generating a Report

Once at least one AI Profile has been created, reports can be generated directly from the main dashboard.

. Select a **single** health check run on the timeline. This will enable the "Generate AI Report" button.
. From the dropdown menus in the "Actions" card, select:
.. An *AI Profile* to use for the analysis.
.. An *Analysis Rule Set* to guide the AI's focus.
.. A *Report Template* to define the audience and format of the output (e.g., Executive Summary, Technical Deep Dive).
. Click the "Generate AI Report" button.
. A modal will appear, prompting you to enter a **Report Name** and an optional **Description**.
. Click "Generate and Download". The system will send the request to the AI, save the report to your history, and trigger a download of the resulting Asciidoc file.

image::docs/images/dashboard_generate_report.png[Generating a Report from the Dashboard]

== 4. Managing Generated Reports

The "Report History" page provides a central location to view and manage all the reports you have generated.

. Navigate to the "Report History" page from the link in the dashboard header.
. The table displays all your past reports, with context about the target system and the configuration used.
. From the "Actions" column, you can:
.. *Edit:* Update the report's name, description, and add ongoing annotations or notes.
.. *Download:* Re-download the Asciidoc file for a previously generated report at any time.

image::docs/images/report_history.png[Report History Page]

== 5. Technical Architecture Overview

This feature is built on a decoupled, database-driven architecture.

* **Database as the Source of Truth:** All configurations—AI providers, user profiles, analysis rules, and prompt templates—are stored in dedicated tables in the `health_trends` database. This eliminates any dependency on the main application's file system.
* **Decoupled Modules:** The core logic is contained within two new modules in the `trends_app`:
** `ai_connector.py`:** A self-contained module responsible for all communication with external AI APIs.
** `prompt_generator.py`:** A self-contained module that reads run data, analysis rules, and prompt templates from the database to construct intelligent, context-aware prompts.
* **Security:** All sensitive credentials (system and user API keys) are encrypted in the database using `pgcrypto`. All API endpoints are secured with privilege checks.

