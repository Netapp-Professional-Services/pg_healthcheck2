= Integration Test Failure Correction Prompt
:toc: left

[cite_start]You are an expert database developer and debugger[cite: 1]. [cite_start]An integration test has failed for a health check module, and you need to fix the issue[cite: 2].

== Test Failure Information

*Database Type:* {{ database_type }}

*Error Message:*
----
{{ test_error }}
----

*Full Test Output:*
----
{{ test_output }}
----

== Current Code

*Query File:* {{ query_file_path }}
----
{{ query_file_content }}
----

*Check Module:*
----
{{ check_module_content }}
----

== Your Task

Analyze the error and fix the issue. [cite_start]Common problems include[cite: 4]:

* [cite_start]**Column Name Errors:** Using wrong column names or forgetting aliases[cite: 4].
* [cite_start]**SQL Syntax Errors:** Missing parentheses, incorrect operator precedence, or division by zero[cite: 4].
* [cite_start]**Version Compatibility:** Using features or tables not available in an older database version[cite: 4].
* [cite_start]**Logic Errors:** Incorrect filtering or aggregation[cite: 4].
* **Framework Contract Errors:** Defining a query function with the wrong signature (e.g., omitting the mandatory `connector` parameter).

== Advanced Correction Examples

=== Example 1: Fixing a Column Name Error

[cite_start]*Error:* `column "tablename" does not exist` [cite: 6]

*Original Query:*
----
SELECT schemaname, tablename, n_dead_tup
FROM pg_stat_user_tables
----

*Corrected Query:*
----
SELECT schemaname, relname AS tablename, n_dead_tup
FROM pg_stat_user_tables
----

---

=== Example 2: Fixing a Syntax Error (Operator Precedence)

*Error:* `syntax error at or near "AND"`

*Original Query:*
----
SELECT count(*)
FROM pg_locks
WHERE granted AND locktype = 'relation' OR locktype = 'transactionid'
----

*Corrected Query:*
----
SELECT count(*)
FROM pg_locks
WHERE granted AND (locktype = 'relation' OR locktype = 'transactionid')
----

---

=== Example 3: Fixing a Division by Zero Error

*Error:* `division by zero`

*Original Query:*
----
SELECT
  relname,
  n_dead_tup * 100 / (n_live_tup + n_dead_tup) AS bloat_percent
FROM pg_stat_user_tables
----

*Corrected Query:*
----
SELECT
  relname,
  n_dead_tup * 100 / NULLIF(n_live_tup + n_dead_tup, 0) AS bloat_percent
FROM pg_stat_user_tables
----

---

=== Example 4: Fixing a Version Compatibility Error

*Error:* `relation "pg_stat_wal" does not exist`

*Explanation:* This error means the query is being run on a version of PostgreSQL older than version 10, where the `pg_stat_wal` view does not exist. The fix is not to change the query itself, but to add a version check in the `check_module` to prevent the query from running on unsupported versions.

*Corrected Check Module (the query file remains unchanged):*
----
# in checks/check_wal_stats.py
from .utils.qrylib import get_wal_stats_query

def run_check_wal_stats(connector, settings):
    adoc_content = []
    # Check for version before running a version-specific query
    if hasattr(connector, 'version_info') and connector.version_info.get('major_version', 0) >= 10:
        query = get_wal_stats_query(connector)
        formatted, raw = connector.execute_query(query, return_raw=True)
        # ... process results ...
    else:
        adoc_content.append("[NOTE]\n====\nWAL statistics check is skipped (requires PostgreSQL 10+).\n====\n")
        raw = {}
    
    # ... return report ...
----

---

=== Example 5: Fixing a Framework Contract Error (Missing Argument)

*Error:* `TypeError: get_list_topics_query() takes 0 positional arguments but 1 was given`

*Explanation:* This error occurs when a query function in the `qrylib` file is incorrectly defined without the mandatory `connector` parameter. The framework always calls these functions with the `connector`, causing a mismatch.

*Original Query File:*
----
# in plugins/kafka/utils/qrylib/topic_queries.py
import json

# INCORRECT: Missing the 'connector' parameter
def get_list_topics_query():
    return json.dumps({"operation": "list_topics"})
----

*Corrected Query File:*
----
# in plugins/kafka/utils/qrylib/topic_queries.py
import json

# CORRECT: The 'connector' parameter is added to conform to the framework contract.
def get_list_topics_query(connector):
    # The connector parameter is required by the framework's calling convention,
    # even if it is not used inside the function body.
    return json.dumps({"operation": "list_topics"})
----


== Output Format

Return ONLY a JSON object with corrected file content:

[source,json]
----
{
  "query_file": "corrected query file content here (full file)",
  "check_module": "corrected check module content here (only if needed, otherwise omit)"
}
----

*CRITICAL:*
- Return the FULL file content, not just the changed parts.
- Fix ONLY the specific error reported.
- Do not change unrelated code.

Now fix the error in the provided code.
